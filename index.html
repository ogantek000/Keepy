<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0,
               maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

<title>Keepy – Keep Going</title>

<style>
/* ===== BLOKADA PODSKAKIWANIA EKRANU ===== */
html, body {
  margin: 0;
  padding: 0;
  overscroll-behavior: none;
  background: #0e0e11;
  color: #fff;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
}

/* ===== LISTA ===== */
#list {
  padding: 16px;
}

.habit {
  background: #1b1b22;
  border-radius: 14px;
  padding: 14px 12px;
  margin-bottom: 12px;
  display: flex;
  align-items: center;
  gap: 12px;
}

/* ===== UCHWYT DRAG ===== */
.drag-handle {
  font-size: 22px;
  opacity: 0.7;
  cursor: grab;

  /* KLUCZOWE DLA MOBILE */
  touch-action: none;
  user-select: none;
}

.dragging {
  opacity: 0.4;
}

/* ===== TEKST ===== */
.name {
  flex: 1;
  font-size: 16px;
}
</style>
</head>

<body>

<div id="list"></div>

<script>
/* ===== DANE ===== */
let habits = JSON.parse(localStorage.getItem('habits')) || [
  { name: 'Trening' },
  { name: 'Czytanie' },
  { name: 'Nauka hiszpańskiego' }
];

let draggedIndex = null;
let isTouchDragging = false;
let touchIndex = null;

/* ===== POMOCNICZE ===== */
function save() {
  localStorage.setItem('habits', JSON.stringify(habits));
}

function isMobile() {
  return 'ontouchstart' in window;
}

/* ===== RENDER ===== */
function render() {
  const list = document.getElementById('list');
  list.innerHTML = '';

  habits.forEach((h, i) => {
    const div = document.createElement('div');
    div.className = 'habit';

    const handle = document.createElement('div');
    handle.className = 'drag-handle';
    handle.textContent = '⋮⋮';

    const name = document.createElement('div');
    name.className = 'name';
    name.textContent = h.name;

    div.appendChild(handle);
    div.appendChild(name);
    list.appendChild(div);

    enableDrag(div, handle, i);
  });
}

/* ===== DRAG & DROP ===== */
function enableDrag(container, handle, index) {

  /* ===== MOBILE (TOUCH) ===== */
  if (isMobile()) {

    handle.addEventListener('touchstart', e => {
      isTouchDragging = true;
      touchIndex = index;
      container.classList.add('dragging');
    }, { passive: false });

    handle.addEventListener('touchmove', e => {
      if (!isTouchDragging) return;
      e.preventDefault(); // BLOKUJE BOUNCE

      const touch = e.touches[0];
      const target = document.elementFromPoint(touch.clientX, touch.clientY);
      const habitEl = target?.closest('.habit');
      if (!habitEl) return;

      const all = [...document.querySelectorAll('.habit')];
      const targetIndex = all.indexOf(habitEl);

      if (targetIndex !== -1 && targetIndex !== touchIndex) {
        const moved = habits.splice(touchIndex, 1)[0];
        habits.splice(targetIndex, 0, moved);
        touchIndex = targetIndex;
        save();
        render();
      }
    }, { passive: false });

    handle.addEventListener('touchend', () => {
      isTouchDragging = false;
      container.classList.remove('dragging');
    });

  /* ===== DESKTOP ===== */
  } else {

    handle.setAttribute('draggable', 'true');

    handle.ondragstart = () => {
      draggedIndex = index;
      container.classList.add('dragging');
    };

    handle.ondragend = () => {
      draggedIndex = null;
      container.classList.remove('dragging');
    };

    container.ondragover = e => e.preventDefault();

    container.ondrop = e => {
      e.preventDefault();
      if (draggedIndex === null || draggedIndex === index) return;

      const moved = habits.splice(draggedIndex, 1)[0];
      habits.splice(index, 0, moved);
      save();
      render();
    };
  }
}

/* ===== GLOBALNA BLOKADA SCROLLA PODCZAS DRAG ===== */
document.addEventListener('touchmove', e => {
  if (isTouchDragging) e.preventDefault();
}, { passive: false });

/* ===== START ===== */
render();
</script>

</body>
</html>

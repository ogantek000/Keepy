<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Keepy ‚Äì Keep Going</title>
<link rel="icon" href="icon.png">

<style>
:root {
  --bg-primary: #0f172a;
  --bg-secondary: rgba(255,255,255,0.05);
  --bg-tertiary: #1e293b;
  --text-primary: white;
  --text-secondary: #94a3b8;
  --accent: #3b82f6;
  --success: #22c55e;
  --warning: #facc15;
  --danger: #ef4444;
}

[data-theme="light"] {
  --bg-primary: #f8fafc;
  --bg-secondary: rgba(0,0,0,0.05);
  --bg-tertiary: #e2e8f0;
  --text-primary: #0f172a;
  --text-secondary: #64748b;
}

[data-theme="ocean"] {
  --bg-primary: #0a192f;
  --bg-secondary: rgba(100,255,218,0.08);
  --bg-tertiary: #172a45;
  --accent: #64ffda;
  --text-primary: #ccd6f6;
  --text-secondary: #8892b0;
}

body{
  font-family:-apple-system,BlinkMacSystemFont,'Helvetica Neue',sans-serif;
  background:var(--bg-primary);
  color:var(--text-primary);
  margin:0;padding:16px;
  transition:background .3s, color .3s;
}

.header{text-align:center;margin-bottom:10px;position:relative}
.theme-toggle{
  position:absolute;top:0;right:0;
  background:var(--bg-tertiary);border:none;
  padding:8px 12px;border-radius:8px;cursor:pointer;
  color:var(--text-primary);font-size:18px;
}
.mascot{width:200px;height:200px;border-radius:50%;object-fit:cover}
h1{margin:6px 0 2px;color:var(--accent)}
.motto{color:var(--text-secondary);font-size:14px}
#countdown{font-size:16px;font-weight:600;color:var(--text-secondary);margin:6px 0 14px}

#stats{
  display:flex;justify-content:space-around;
  background:var(--bg-secondary);
  padding:12px;border-radius:14px;margin-bottom:14px;
}
#stats div{text-align:center}
#stats div div:first-child{font-size:13px;color:var(--text-secondary)}
#stats div div:last-child{font-size:18px;font-weight:bold;color:var(--accent)}

.charts{
  background:var(--bg-secondary);
  padding:16px;border-radius:14px;margin-bottom:14px;
}
.charts h3{margin:0 0 12px;font-size:16px;color:var(--text-secondary)}
.heat-map{
  display:grid;grid-template-columns:repeat(7,1fr);
  gap:4px;margin-bottom:16px;
}
.heat-day{
  aspect-ratio:1;border-radius:4px;
  background:var(--bg-tertiary);
}
.heat-day.level-1{background:#16a34a;opacity:0.3}
.heat-day.level-2{background:#16a34a;opacity:0.6}
.heat-day.level-3{background:#16a34a;opacity:0.9}
.heat-day.level-4{background:#16a34a}

.habit{
  background:var(--bg-secondary);
  padding:16px;border-radius:14px;margin-bottom:12px;
  opacity:0;transform:translateY(20px);
  transition:.25s;position:relative;
  cursor:move;
  border-left:4px solid transparent;
}
.habit.show{opacity:1;transform:none}
.habit.dragging{opacity:0.5}

.habit.ice::after{
  content:"";position:absolute;inset:0;
  background:var(--accent);opacity:0;border-radius:14px;
  animation:ice .8s
}
@keyframes ice{30%,60%{opacity:.6}100%{opacity:0}}

.category-badge{
  display:inline-block;
  padding:4px 12px;border-radius:12px;
  font-size:12px;font-weight:600;
  margin-bottom:8px;
}
.cat-sport{background:#3b82f6;color:white}
.cat-health{background:#22c55e;color:white}
.cat-work{background:#f59e0b;color:white}
.cat-study{background:#8b5cf6;color:white}
.cat-hobby{background:#ec4899;color:white}
.cat-other{background:#6b7280;color:white}

.habit-header{
  display:flex;justify-content:space-between;align-items:center
}
.name{font-size:18px}
.streak{font-size:20px;color:#ff9500}

.actions{display:flex;gap:6px;flex-wrap:wrap}
.actions button{
  padding:6px 10px;border:none;border-radius:8px;cursor:pointer;
  font-size:13px;
}
.done{background:var(--success);color:white}
.freeze{background:var(--warning);color:black}
.more{background:var(--bg-tertiary);color:var(--text-primary);font-size:18px}

.menu{
  position:absolute;right:12px;top:52px;
  background:var(--bg-primary);border-radius:10px;
  overflow:hidden;display:none;
  box-shadow:0 10px 30px rgba(0,0,0,.5);z-index:2;
  border:1px solid var(--bg-tertiary);
}
.menu button{
  width:100%;padding:10px 14px;
  background:none;border:none;color:var(--text-primary);
  text-align:left;cursor:pointer;
}
.menu button:hover{background:var(--bg-secondary)}

.toggle-cal{
  width:100%;margin-top:8px;
  padding:8px;border:none;border-radius:8px;
  background:var(--accent);color:white;cursor:pointer
}

.calendar-container{margin-top:8px;position:relative}
.calendar{
  max-height:0;opacity:0;overflow:hidden;
  transition:.35s;pointer-events:none;
}
.calendar.show{max-height:400px;opacity:1;pointer-events:auto}

.calendar.editing{
  outline:2px dashed #f97316
}

.calendar-nav{
  display:flex;justify-content:space-between;align-items:center;
  margin-bottom:8px;
  gap:12px;
}
.calendar-nav span{
  color:var(--text-primary);font-weight:bold;
  flex:1;text-align:center;
}
.calendar-nav button{
  background:var(--bg-tertiary);color:var(--text-primary);border:none;padding:6px 12px;border-radius:4px;
  cursor:pointer;flex-shrink:0;
}

.calendar-days{
  display:flex;flex-wrap:wrap;
}

.day{
  width:14.2%;height:28px;
  line-height:28px;text-align:center;
  font-size:12px;border-radius:6px;
  background:var(--bg-tertiary)
}
.calendar.editing .day{cursor:pointer}

.day.done{background:var(--success);color:white}
.day.freeze{background:var(--warning);color:black}
.day.missed{background:var(--danger);color:white}
.day.locked{opacity:.35}

.add{
  position:fixed;bottom:24px;right:24px;
  width:56px;height:56px;border-radius:50%;
  background:var(--success);color:white;font-size:32px;border:none;cursor:pointer;
  box-shadow:0 4px 12px rgba(0,0,0,0.3);
}

.modal{
  display:none;position:fixed;inset:0;
  background:rgba(0,0,0,0.7);z-index:100;
  align-items:center;justify-content:center;
}
.modal.show{display:flex}
.modal-content{
  background:var(--bg-primary);
  padding:24px;border-radius:16px;
  max-width:400px;width:90%;
  border:1px solid var(--bg-tertiary);
}
.modal h3{margin:0 0 16px;color:var(--accent)}
.modal input, .modal select{
  width:100%;padding:10px;margin-bottom:12px;
  border:1px solid var(--bg-tertiary);
  border-radius:8px;background:var(--bg-secondary);
  color:var(--text-primary);
  box-sizing:border-box;
}
.modal-buttons{
  display:flex;gap:8px;justify-content:flex-end;
}
.modal-buttons button{
  padding:8px 16px;border:none;border-radius:8px;cursor:pointer;
}
.btn-primary{background:var(--accent);color:white}
.btn-secondary{background:var(--bg-tertiary);color:var(--text-primary)}
</style>
</head>
<body>

<div class="header">
  <button class="theme-toggle" id="themeBtn">üåô</button>
  <img src="bro.jpg" class="mascot">
  <h1>Keepy</h1>
  <p class="motto">Keep Going</p>
  <div id="countdown">--:--:--</div>
</div>

<div id="stats">
  <div><div>Dni wykonane</div><div id="totalDone">0</div></div>
  <div><div>Najd≈Çu≈ºsza passa</div><div id="maxStreak">0</div></div>
  <div><div>≈örednia dzienna</div><div id="avgDaily">0</div></div>
</div>

<div class="charts">
  <h3>üìä Aktywno≈õƒá (ostatnie 28 dni)</h3>
  <p style="font-size:13px;color:var(--text-secondary);margin:0 0 12px">Ka≈ºdy kwadrat to jeden dzie≈Ñ. Im ciemniejszy kolor, tym wiƒôcej pass zrobi≈Çe≈õ tego dnia.</p>
  <div class="heat-map" id="heatMap"></div>
</div>

<div id="list"></div>
<button class="add" id="addBtn">+</button>

<div class="modal" id="addModal">
  <div class="modal-content">
    <h3>‚ûï Dodaj nowƒÖ passƒô</h3>
    <input type="text" id="habitName" placeholder="Nazwa passy">
    <select id="habitCategory">
      <option value="sport">üèÉ Sport</option>
      <option value="health">üíö Zdrowie</option>
      <option value="work">üíº Praca</option>
      <option value="study">üìö Nauka</option>
      <option value="hobby">üé® Hobby</option>
      <option value="other">‚ö™ Inne</option>
      <option value="custom">‚ûï W≈Çasna kategoria...</option>
    </select>
    <input type="text" id="customCategory" placeholder="Wpisz nazwƒô w≈Çasnej kategorii" style="display:none">
    <div class="modal-buttons">
      <button class="btn-secondary" id="cancelBtn">Anuluj</button>
      <button class="btn-primary" id="saveBtn">Zapisz</button>
    </div>
  </div>
</div>

<div class="modal" id="editCategoryModal">
  <div class="modal-content">
    <h3>üè∑Ô∏è Zmie≈Ñ kategoriƒô</h3>
    <select id="editCategorySelect">
      <option value="sport">üèÉ Sport</option>
      <option value="health">üíö Zdrowie</option>
      <option value="work">üíº Praca</option>
      <option value="study">üìö Nauka</option>
      <option value="hobby">üé® Hobby</option>
      <option value="other">‚ö™ Inne</option>
      <option value="custom">‚ûï W≈Çasna kategoria...</option>
    </select>
    <input type="text" id="editCustomCategory" placeholder="Wpisz nazwƒô w≈Çasnej kategorii" style="display:none">
    <div class="modal-buttons">
      <button class="btn-secondary" id="cancelEditCatBtn">Anuluj</button>
      <button class="btn-primary" id="saveEditCatBtn">Zapisz</button>
    </div>
  </div>
</div>

<script>
const DAY=86400000;
const list=document.getElementById("list");
const themes=['dark','light','ocean'];
let currentTheme=0;

function today(){
  const d=new Date();
  d.setMinutes(d.getMinutes()-d.getTimezoneOffset());
  return d.toISOString().slice(0,10);
}

function startCountdown(){
  const el=document.getElementById("countdown");
  setInterval(()=>{
    const now=new Date();
    const midnight=new Date();
    midnight.setHours(24,0,0,0);
    const diff=midnight-now;
    const h=String(Math.floor(diff/3600000)).padStart(2,"0");
    const m=String(Math.floor(diff%3600000/60000)).padStart(2,"0");
    const s=String(Math.floor(diff%60000/1000)).padStart(2,"0");
    el.textContent=`${h}:${m}:${s}`;
  },1000);
}
startCountdown();

let habits=JSON.parse(localStorage.getItem("keepy"))||[];
const save=()=>localStorage.setItem("keepy",JSON.stringify(habits));

// Theme toggle
document.getElementById("themeBtn").onclick=()=>{
  currentTheme=(currentTheme+1)%themes.length;
  document.body.setAttribute('data-theme',themes[currentTheme]);
  document.getElementById("themeBtn").textContent=themes[currentTheme]==='light'?'‚òÄÔ∏è':themes[currentTheme]==='ocean'?'üåä':'üåô';
  localStorage.setItem("theme",themes[currentTheme]);
};

const savedTheme=localStorage.getItem("theme");
if(savedTheme){
  currentTheme=themes.indexOf(savedTheme);
  document.body.setAttribute('data-theme',savedTheme);
  document.getElementById("themeBtn").textContent=savedTheme==='light'?'‚òÄÔ∏è':savedTheme==='ocean'?'üåä':'üåô';
}

function updateStats(){
  let total=0,max=0,dates={};
  habits.forEach(h=>{
    h.datesDone.forEach(d=>{
      total++;dates[d]=(dates[d]||0)+1;
    });
    if(h.streak>max)max=h.streak;
  });
  const days=Object.keys(dates).length||1;
  totalDone.textContent=total;
  maxStreak.textContent=max;
  avgDaily.textContent=(total/days).toFixed(2);
  
  // Heat map
  const heatMap=document.getElementById("heatMap");
  heatMap.innerHTML="";
  for(let i=27;i>=0;i--){
    const d=new Date();
    d.setDate(d.getDate()-i);
    const ds=new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10);
    const count=dates[ds]||0;
    const div=document.createElement("div");
    div.className="heat-day";
    if(count>0)div.classList.add(`level-${Math.min(count,4)}`);
    div.title=`${ds}: ${count} pass${count===1?'a':''}`;
    heatMap.append(div);
  }
}

function renderCalendar(h){
  const cont=document.createElement("div");
  cont.className="calendar-container";

  const cal=document.createElement("div");
  cal.className="calendar";
  if(h.calendarOpen) cal.classList.add("show");
  if(h.editing) cal.classList.add("editing");

  const ref=new Date();
  ref.setMonth(ref.getMonth()+h.monthOffset);
  
  const nav=document.createElement("div");
  nav.className="calendar-nav";
  const l=document.createElement("button");
  l.textContent="<";
  const r=document.createElement("button");
  r.textContent=">";
  const title=document.createElement("span");
  title.textContent=ref.toLocaleString("pl-PL",{month:"long",year:"numeric"});

  nav.append(l,title,r);
  cal.append(nav);

  l.onclick=(e)=>{e.stopPropagation(); h.monthOffset--; save(); render();}
  r.onclick=(e)=>{e.stopPropagation(); h.monthOffset++; save(); render();}

  const daysContainer=document.createElement("div");
  daysContainer.className="calendar-days";

  const first=(new Date(ref.getFullYear(),ref.getMonth(),1).getDay()+6)%7;
  const daysInMonth=new Date(ref.getFullYear(),ref.getMonth()+1,0).getDate();

  for(let i=0;i<first;i++) daysContainer.append(document.createElement("div"));
  for(let d=1;d<=daysInMonth;d++){
    const date=new Date(ref.getFullYear(),ref.getMonth(),d);
    const ds=new Date(date.getTime()-date.getTimezoneOffset()*60000).toISOString().slice(0,10);
    const diff=(new Date(today())-new Date(ds))/DAY;
    const editable=diff>=0 && diff<=7;

    const div=document.createElement("div");
    div.className="day";
    div.textContent=d;

    if(h.datesDone.includes(ds)) div.classList.add("done");
    else if(h.freezeDates.includes(ds)) div.classList.add("freeze");
    else if(diff>0) div.classList.add("missed");
    if(!editable) div.classList.add("locked");

    div.onclick=()=>{
      if(!h.editing || !editable) return;
      if(h.datesDone.includes(ds))
        h.datesDone=h.datesDone.filter(x=>x!==ds);
      else
        h.datesDone.push(ds);
      save(); render();
    };

    daysContainer.append(div);
  }

  cal.append(daysContainer);
  cont.append(cal);
  return {cont,cal};
}

let draggedIndex=null;

function getCategoryLabel(category){
  const defaultLabels={
    sport:'üèÉ Sport',
    health:'üíö Zdrowie',
    work:'üíº Praca',
    study:'üìö Nauka',
    hobby:'üé® Hobby',
    other:'‚ö™ Inne'
  };
  return defaultLabels[category]||`‚≠ê ${category}`;
}

function getCategoryColor(category){
  const defaultColors={
    sport:'#3b82f6',
    health:'#22c55e',
    work:'#f59e0b',
    study:'#8b5cf6',
    hobby:'#ec4899',
    other:'#6b7280'
  };
  return defaultColors[category]||'#10b981';
}

function render(){
  list.innerHTML="";
  habits.forEach((h,i)=>{
    const div=document.createElement("div");
    div.className="habit";
    div.draggable=true;
    
    div.style.borderLeftColor=getCategoryColor(h.category||'other');

    div.innerHTML=`
      <span class="category-badge cat-${h.category||'other'}">${getCategoryLabel(h.category||'other')}</span>
      <div class="habit-header">
        <div>
          <div class="name">${h.name}</div>
          <div class="streak">üî• ${h.streak}</div>
        </div>
        <div class="actions">
          <button class="done">Zrobione dzi≈õ</button>
          <button class="freeze">${h.freeze?"Odmr√≥≈∫":"Freeze"}</button>
          <button class="more">‚ãØ</button>
        </div>
      </div>
      <div class="menu">
        <button class="editHist">‚úèÔ∏è Edytuj historiƒô</button>
        <button class="changeCat">üè∑Ô∏è Zmie≈Ñ kategoriƒô</button>
        <button class="deleteHist">üóë Usu≈Ñ passƒô</button>
      </div>
    `;

    // Drag & drop
    div.ondragstart=(e)=>{
      draggedIndex=i;
      div.classList.add('dragging');
    };
    div.ondragend=()=>{
      div.classList.remove('dragging');
    };
    div.ondragover=(e)=>{
      e.preventDefault();
    };
    div.ondrop=(e)=>{
      e.preventDefault();
      if(draggedIndex!==null && draggedIndex!==i){
        const temp=habits[draggedIndex];
        habits.splice(draggedIndex,1);
        habits.splice(i,0,temp);
        save();
        render();
      }
    };

    const menu=div.querySelector(".menu");
    div.querySelector(".more").onclick=()=>{menu.style.display=menu.style.display==="block"?"none":"block";};

    const toggle=document.createElement("button");
    toggle.className="toggle-cal";
    toggle.textContent=h.calendarOpen?"üìÖ Ukryj kalendarz":"üìÖ Poka≈º kalendarz";

    const {cont,cal}=renderCalendar(h);

    toggle.onclick=()=>{h.calendarOpen=!h.calendarOpen; save(); render();};

    div.querySelector(".editHist").onclick=()=>{h.editing=!h.editing; menu.style.display="none"; save(); render();};
    div.querySelector(".changeCat").onclick=()=>{
      menu.style.display="none";
      const editCatModal=document.getElementById("editCategoryModal");
      editCatModal.classList.add("show");
      editCatModal.dataset.habitIndex=i;
      document.getElementById("editCategorySelect").value=h.category||'other';
    };
    div.querySelector(".deleteHist").onclick=()=>{if(confirm("UsunƒÖƒá passƒô?")){habits.splice(i,1); save(); render();}};
    div.querySelector(".done").onclick=()=>{if(h.freeze) return; if(!h.datesDone.includes(today())){h.datesDone.push(today()); h.streak++; save(); render();}};
    div.querySelector(".freeze").onclick=()=>{h.freeze=!h.freeze; div.classList.add("ice"); setTimeout(()=>div.classList.remove("ice"),800); save(); render();};

    div.append(toggle,cont);
    list.append(div);
    setTimeout(()=>div.classList.add("show"),10);
  });
  updateStats();
}

// Modal
const modal=document.getElementById("addModal");
document.getElementById("addBtn").onclick=()=>{
  modal.classList.add("show");
  document.getElementById("habitName").value="";
  document.getElementById("habitCategory").value="sport";
  document.getElementById("customCategory").style.display="none";
};

document.getElementById("habitCategory").onchange=(e)=>{
  const customInput=document.getElementById("customCategory");
  customInput.style.display=e.target.value==='custom'?'block':'none';
  if(e.target.value==='custom') customInput.focus();
};

document.getElementById("cancelBtn").onclick=()=>{
  modal.classList.remove("show");
};

document.getElementById("saveBtn").onclick=()=>{
  const n=document.getElementById("habitName").value.trim();
  let c=document.getElementById("habitCategory").value;
  if(c==='custom'){
    const custom=document.getElementById("customCategory").value.trim();
    if(!custom) return alert("Wpisz nazwƒô kategorii");
    c=custom;
  }
  if(n){
    habits.push({name:n,category:c,streak:0,datesDone:[],freezeDates:[],freeze:false,monthOffset:0,calendarOpen:false,editing:false});
    save();render();
    modal.classList.remove("show");
  }
};

modal.onclick=(e)=>{
  if(e.target===modal) modal.classList.remove("show");
};

// Edit Category Modal
const editCatModal=document.getElementById("editCategoryModal");

document.getElementById("editCategorySelect").onchange=(e)=>{
  const customInput=document.getElementById("editCustomCategory");
  customInput.style.display=e.target.value==='custom'?'block':'none';
  if(e.target.value==='custom') customInput.focus();
};

document.getElementById("cancelEditCatBtn").onclick=()=>{
  editCatModal.classList.remove("show");
};

document.getElementById("saveEditCatBtn").onclick=()=>{
  const idx=parseInt(editCatModal.dataset.habitIndex);
  let c=document.getElementById("editCategorySelect").value;
  if(c==='custom'){
    const custom=document.getElementById("editCustomCategory").value.trim();
    if(!custom) return alert("Wpisz nazwƒô kategorii");
    c=custom;
  }
  habits[idx].category=c;
  save();
  render();
  editCatModal.classList.remove("show");
};

editCatModal.onclick=(e)=>{
  if(e.target===editCatModal) editCatModal.classList.remove("show");
};

render();
</script>
</body>
</html>
